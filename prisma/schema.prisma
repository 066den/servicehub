generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      Int                @id @default(autoincrement())
  phone                   String             @unique
  phoneNormalized         String?            @unique
  email                   String?            @unique
  emailVerifiedAt         DateTime?
  isEmailVerified         Boolean            @default(false)
  password                String?
  passwordUpdatedAt       DateTime?
  firstName               String
  lastName                String?
  avatar                  String?
  location                Json?
  role                    Role               @default(CLIENT)
  isVerified              Boolean            @default(false)
  lastLoginAt             DateTime?
  isActive                Boolean            @default(true)
  isBlocked               Boolean            @default(false)
  notificationPreferences Json?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  orders                  Order[]            @relation("ClientOrders")
  providers               Provider?
  refreshTokens           RefreshToken[]
  reviews                 Review[]           @relation("ClientReviews")
  sessions                Session[]
  verificationCodes       VerificationCode[]

  @@index([phone])
  @@index([email])
  @@index([role])
}

model Provider {
  id                    Int              @id @default(autoincrement())
  userId                Int              @unique
  type                  ProviderType     @default(INDIVIDUAL)
  businessName          String
  description           String?
  avatar                String?
  status                ProviderStatus   @default(APPROVED)
  rating                Float            @default(0)
  reviewCount           Int              @default(0)
  companyInfoId         Int?             @unique
  workingHours          Json?
  serviceAreas          Json?
  documents             Json?
  isActive              Boolean          @default(true)
  isDeleted             Boolean          @default(false)
  subscriptionPlan      SubscriptionPlan @default(FREE)
  subscriptionExpiresAt DateTime?
  location              Json?
  email                 String?
  phone                 String?
  instagram             String?
  facebook              String?
  telegram              String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  deletedAt             DateTime?
  staff                 Staff[]
  orders                Order[]
  companyInfo           CompanyInfo?     @relation(fields: [companyInfoId], references: [id])
  user                  User             @relation(fields: [userId], references: [id])
  reviews               Review[]
  services              Service[]

  @@index([userId])
  @@index([status])
  @@index([rating])
  @@index([subscriptionExpiresAt])
  @@index([deletedAt])
}

model CompanyInfo {
  id                 Int       @id @default(autoincrement())
  legalForm          String?
  registrationNumber String?
  taxNumber          String?
  website            String?
  bankDetails        Json?
  licenses           Json?
  certificates       Json?
  foundedYear        Int?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  provider           Provider?
}

model Staff {
  id              Int             @id @default(autoincrement())
  providerId      Int
  firstName       String
  lastName        String
  phone           String?
  role            StaffRole       @default(WORKER)
  status          StaffStatus     @default(FREE)
  position        String?
  department      String?
  specialization  String?
  experience      Int?
  workingHours    Json?
  avatar          String?
  rating          Float?
  reviewCount     Int?            @default(0)
  hireDate        DateTime        @default(now())
  terminationDate DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  provider        Provider        @relation(fields: [providerId], references: [id], onDelete: Cascade)
  assignedOrders  OrderStaff[]

  @@index([providerId])
  @@index([status])
  @@index([role])
}

model OrderStaff {
  id          Int       @id @default(autoincrement())
  orderId     Int
  staffId     Int
  startTime   DateTime?
  endTime     DateTime?
  hoursWorked Float?    @default(0)
  payment     Float?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  staff       Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, staffId])
  @@index([orderId])
  @@index([staffId])
}

model Service {
  id             Int            @id @default(autoincrement())
  providerId     Int
  name           String
  description    String?
  categoryId     Int
  typeId         Int
  price          Float?
  duration       Int?
  pricingOptions Json?
  location       Json?
  requirements   Json?
  isActive       Boolean        @default(true)
  isFeatured     Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  orders         Order[]
  category       Category       @relation(fields: [categoryId], references: [id])
  provider       Provider       @relation(fields: [providerId], references: [id])
  type           Type           @relation(fields: [typeId], references: [id])
  photos         ServicePhoto[]
  serviceTags    ServiceTag[]

  @@unique([providerId, name])
  @@index([categoryId])
  @@index([typeId])
  @@index([providerId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([isFeatured])
}

model ServicePhoto {
  id        Int       @id @default(autoincrement())
  serviceId Int
  url       String
  alt       String?
  order     Int       @default(0)
  isMain    Boolean   @default(false)
  photoType PhotoType @default(GALLERY)
  service   Service   @relation(fields: [serviceId], references: [id])

  @@index([serviceId])
  @@index([photoType])
}

model Order {
  id                Int             @id @default(autoincrement())
  clientId          Int
  providerId        Int
  serviceId         Int
  status            OrderStatus     @default(CREATED)
  scheduledAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  serviceDetails    Json?
  location          Json?
  clientNotes       String?
  providerNotes     String?
  totalAmount       Float?
  platformFee       Float?
  paymentStatus     PaymentStatus   @default(PENDING)
  photos            String[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?
  estimatedHours    Float?
  actualHours       Float?
  teamNotes         String?
  workLog           Json?
  client            User            @relation("ClientOrders", fields: [clientId], references: [id])
  provider          Provider        @relation(fields: [providerId], references: [id])
  service           Service         @relation(fields: [serviceId], references: [id])
  assignedStaff     OrderStaff[]
  reviews           Review?

  @@index([clientId])
  @@index([providerId])
  @@index([serviceId])
  @@index([status])
  @@index([scheduledAt])
  @@index([deletedAt])
}

model Category {
  id           Int            @id @default(autoincrement())
  name         String
  slug         String?        @unique
  icon         String?
  image        String?
  description  String?
  services     Service[]
  types        Type[]
  subcategories Subcategory[]

  @@index([slug])
}

model Subcategory {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String?   @unique
  image       String?
  icon        String?
  description String?
  categoryId  Int
  types       Type[]
  category    Category  @relation(fields: [categoryId], references: [id])

  @@index([slug])
  @@index([categoryId])
}

model Type {
  id            Int          @id @default(autoincrement())
  name          String
  slug          String?      @unique
  image         String?
  icon          String?
  description   String?
  categoryId    Int
  subcategoryId Int?
  services      Service[]
  category      Category     @relation(fields: [categoryId], references: [id])
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id])

  @@index([slug])
  @@index([categoryId])
  @@index([subcategoryId])
}

model Tag {
  id       Int          @id @default(autoincrement())
  name     String       @unique
  services ServiceTag[]
}

model ServiceTag {
  serviceId Int
  tagId     Int
  service   Service @relation(fields: [serviceId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])

  @@id([serviceId, tagId])
  @@index([serviceId])
  @@index([tagId])
}

model Review {
  id         Int      @id @default(autoincrement())
  orderId    Int      @unique
  clientId   Int
  providerId Int
  rating     Int
  comment    String?
  photos     String[]
  response   String?
  createdAt  DateTime @default(now())
  client     User     @relation("ClientReviews", fields: [clientId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id])
  provider   Provider @relation(fields: [providerId], references: [id])

  @@index([providerId])
  @@index([clientId])
  @@index([rating])
}

model Session {
  id             Int      @id @default(autoincrement())
  userId         Int
  accessToken    String   @unique
  refreshTokenId Int?
  expiresAt      DateTime
  lastActivityAt DateTime @default(now())
  ipAddress      String?
  userAgent      String?
  deviceInfo     String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationCode {
  id          Int       @id @default(autoincrement())
  phone       String
  code        String
  codeType    String    @default("login")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  isUsed      Boolean   @default(false)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  usedAt      DateTime?
  ipAddress   String?
  userId      Int?
  user        User?     @relation(fields: [userId], references: [id])

  @@index([phone, codeType, isUsed, expiresAt])
}

model SmsLog {
  id                Int       @id @default(autoincrement())
  phone             String
  message           String
  provider          String?
  providerMessageId String?
  status            String    @default("pending")
  cost              Decimal   @default(0.0000) @db.Decimal(10, 4)
  errorMessage      String?
  sentAt            DateTime  @default(now())
  deliveredAt       DateTime?
  testMode          Boolean   @default(false)
  createdAt         DateTime  @default(now())
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  deviceId  String?  @map("device_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  CLIENT
  PROVIDER
  ADMIN
}

enum ProviderStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  PREMIUM
}

enum OrderStatus {
  CREATED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PhotoType {
  GALLERY
  BEFORE
  AFTER
}

enum ProviderType {
  INDIVIDUAL
  COMPANY
}

enum StaffRole {
  OWNER
  MANAGER
  WORKER
  SPECIALIST
  ADMIN
}

enum StaffStatus {
  FREE
  BUSY
  ON_VACATION
  INACTIVE
}
